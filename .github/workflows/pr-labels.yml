name: Auto label PRs

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.sha }}
      - name: Fetch PR head
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          git fetch origin "refs/pull/${PR_NUMBER}/head:pr-head"
          git cat-file -e "${PR_BASE_SHA}^{commit}"
          git cat-file -e "${PR_HEAD_SHA}^{commit}" || git cat-file -e "pr-head^{commit}"
      - name: Collect PR diff
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          mkdir -p .tmp/pr-labels
          git diff --name-only "$PR_BASE_SHA" "$PR_HEAD_SHA" > .tmp/pr-labels/changed-files.txt
          git diff "$PR_BASE_SHA" "$PR_HEAD_SHA" > .tmp/pr-labels/changes.diff
      - name: Prepare Codex output
        id: codex-output
        run: |
          set -euo pipefail
          output_dir=".tmp/codex/outputs"
          output_file="${output_dir}/pr-labels.json"
          mkdir -p "$output_dir"
          echo "output_file=${output_file}" >> "$GITHUB_OUTPUT"
      - name: Run Codex labeling
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.PROD_OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/pr-labels.md
          output-file: ${{ steps.codex-output.outputs.output_file }}
          safety-strategy: drop-sudo
          sandbox: read-only
      - name: Apply labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CODEX_OUTPUT_PATH: ${{ steps.codex-output.outputs.output_file }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import subprocess

          pr_number = os.environ["PR_NUMBER"]
          codex_output_path = pathlib.Path(os.environ["CODEX_OUTPUT_PATH"])
          changed_files_path = pathlib.Path(".tmp/pr-labels/changed-files.txt")

          changed_files = []
          if changed_files_path.exists():
              changed_files = [
                  line.strip()
                  for line in changed_files_path.read_text().splitlines()
                  if line.strip()
              ]

          desired = set()
          if "pyproject.toml" in changed_files:
              desired.add("project")
          if any(path.startswith("docs/") for path in changed_files):
              desired.add("documentation")
          if "uv.lock" in changed_files:
              desired.add("dependencies")

          allowed = {
              "documentation",
              "project",
              "bug",
              "enhancement",
              "dependencies",
              "feature:chat-completions",
              "feature:core",
              "feature:lite-llm",
              "feature:mcp",
              "feature:realtime",
              "feature:sessions",
              "feature:tracing",
              "feature:voice",
          }

          codex_labels = []
          if codex_output_path.exists():
              raw = codex_output_path.read_text().strip()
              if raw:
                  try:
                      payload = json.loads(raw)
                      if isinstance(payload, dict):
                          labels = payload.get("labels", [])
                          if isinstance(labels, list):
                              codex_labels = [label for label in labels if isinstance(label, str)]
                  except json.JSONDecodeError:
                      pass

          for label in codex_labels:
              if label in allowed:
                  desired.add(label)

          result = subprocess.check_output(
              ["gh", "pr", "view", pr_number, "--json", "labels", "--jq", ".labels[].name"],
              text=True,
          ).strip()
          existing = {label for label in result.splitlines() if label}

          managed = set(allowed)
          to_add = sorted(desired - existing)
          to_remove = sorted((existing & managed) - desired)

          if not to_add and not to_remove:
              print("Labels already up to date.")
              raise SystemExit(0)

          cmd = ["gh", "pr", "edit", pr_number]
          if to_add:
              cmd += ["--add-label", ",".join(to_add)]
          if to_remove:
              cmd += ["--remove-label", ",".join(to_remove)]

          subprocess.check_call(cmd)
          PY
